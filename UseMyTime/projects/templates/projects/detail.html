{% extends "base.html" %}
{% block title %}Проект "{{ object.title }}"{% endblock %}
{% block content %}
    <div class="row">
        <!-- Основная информация о проекте -->
        <div class="col-md-8">
            <h1>{{ object.title }}</h1>
            <p class="mb-4">{{ object.description }}</p>
        </div>
        
        <!-- Блок проверки проекта (перенесен в правый верхний угол) -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Проверка проекта</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Статус: </strong>
                        <span class="badge 
                            {% if object.review_status == 'none' %}bg-secondary{% endif %}
                            {% if object.review_status == 'in_review' %}bg-warning text-dark{% endif %}
                            {% if object.review_status == 'approved' %}bg-success{% endif %}
                            {% if object.review_status == 'rejected' %}bg-danger{% endif %}
                        ">
                            {% if object.review_status == 'none' %}Не на проверке{% endif %}
                            {% if object.review_status == 'in_review' %}На проверке{% endif %}
                            {% if object.review_status == 'approved' %}Принят{% endif %}
                            {% if object.review_status == 'rejected' %}Возвращен{% endif %}
                        </span>
                        {% if object.review_status == 'rejected' and object.review_comment %}
                            <div class="alert alert-danger mt-2 p-2 small">
                                <strong>Комментарий:</strong> {{ object.review_comment }}
                            </div>
                        {% endif %}
                    </div>

                    {% if can_submit_review and user.id == object.user.id %}
                    <form method="post" action="{% url 'project_submit_review' object.pk %}" enctype="multipart/form-data" id="submit-review-form" class="mb-3">
                        {% csrf_token %}
                        <div class="mb-2">
                            <input type="text" name="submit_comment" class="form-control form-control-sm" placeholder="Комментарий (опционально)"/>
                        </div>
                        <div class="mb-2">
                            <input type="file" name="files" class="form-control form-control-sm" multiple />
                        </div>
                        <button type="submit" class="btn btn-warning btn-sm w-100" onclick="return confirmSubmit()">
                            <i class="bi bi-send"></i> Отправить на проверку
                        </button>
                    </form>
                    {% endif %}

                    {% with role=user.profile.role|default:'' %}
                    {% if role == 'manager' or role == 'sector_manager' %}
                        {% if object.review_status == 'in_review' and object.user_id != user.id %}
                        <div class="d-grid gap-2">
                            <form method="post" action="{% url 'project_review_approve' object.pk %}" class="d-inline">
                                {% csrf_token %}
                                <button class="btn btn-success btn-sm w-100">
                                    <i class="bi bi-check-circle"></i> Принять
                                </button>
                            </form>
                            <form method="post" action="{% url 'project_review_reject' object.pk %}" class="d-inline">
                                {% csrf_token %}
                                <input type="text" name="review_comment" class="form-control form-control-sm mb-2" placeholder="Комментарий" required/>
                                <button class="btn btn-danger btn-sm w-100">
                                    <i class="bi bi-arrow-counterclockwise"></i> Вернуть на доработку
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    {% endif %}
                    {% endwith %}
                </div>
                
                {% if object.submit_comment or object.attachments.all %}
                <div class="card-footer bg-light">
                    <div class="small text-muted">Материалы отправки:</div>
                    {% if object.submit_comment %}
                        <div class="mb-2 small">{{ object.submit_comment }}</div>
                    {% endif %}
                    {% if object.attachments.all %}
                        <div class="small">
                            {% for a in object.attachments.all %}
                                <div>
                                    <a href="{% url 'project_attachment_download' object.pk a.pk %}" target="_blank" class="text-decoration-none">
                                        <i class="bi bi-file-earmark-arrow-down"></i> Файл {{ forloop.counter }}
                                    </a>
                                    <span class="text-muted small">({{ a.uploaded_at|date:"d.m.Y H:i" }})</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <hr>

    <!-- Список задач -->
    {% if object.tasks.all %}
    <h2 class="fw-light">Список задач</h2>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Задача</th>
            <th>Статус</th>
            <th>Создана</th>
            <th>Завершена</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for task in object.tasks.all %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td class="{% if task.status == 'done' %}text-muted text-decoration-line-through{% endif %}">{{ task.text }}</td>
            <td>{{ task.get_status_display }}</td>
            <td>{{ task.created_at|date:"d.m.Y H:i" }}</td>
            <td>{% if task.completed_at %}{{ task.completed_at|date:"d.m.Y H:i" }}{% else %}—{% endif %}</td>
            <td class="text-end">
              {% if user.id == object.user.id %}
                {% if task.status == 'new' %}
                <button class="btn btn-sm btn-primary task-action" data-task-id="{{ task.id }}" data-next="start">Начать</button>
                {% elif task.status == 'in_progress' %}
                <button class="btn btn-sm btn-success task-action" data-task-id="{{ task.id }}" data-next="finish">Завершить</button>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center">Задач нет</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <hr>
    {% endif %}

    <!-- Данные о времени работы -->
    <div class="row">
        <div class="col text-start w-75"><h2 class="fw-light">Общее время работы над проектом</h2></div>
        <div class="col text-end"><h1 id="project-total">{{ object.get_hours_minutes_seconds.0 }} часов {{ object.get_hours_minutes_seconds.1 }} мин {{ object.get_hours_minutes_seconds.2 }} сек</h1></div>
    </div>
    <hr>
    <!-- Кнопки управления проектом -->
    <div class="d-flex justify-content-between mt-4">
        <div>
            {% if user.id == object.user.id %}
              {% if not object.is_archived %}
                  {% if not user.active_project or user.active_project.project != object %}
                  <form action="{% url 'projects_activate' %}" method="post" class="d-inline me-2">
                      {% csrf_token %}
                      <input type="hidden" name="project_id" value="{{ object.pk }}">
                      <button type="submit" class="btn btn-primary">
                          Активировать проект
                      </button>
                  </form>
                  {% endif %}
                  
                  <form action="{% url 'projects_archivate' object.id %}" method="post" class="d-inline me-2">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-secondary">
                          В архив
                      </button>
                  </form>
              {% endif %}
            {% endif %}
        </div>
        
        <div>
            {% if user.id == object.user.id %}
              <a href="{% url 'project_update' object.pk %}" 
              class="btn btn-secondary me-2 {% if object.review_status == 'in_review' or object.review_status == 'approved' %}disabled{% endif %}"
              {% if object.review_status == 'in_review' or object.review_status == 'approved' %}tabindex="-1" aria-disabled="true"{% endif %}>
                  Редактировать
              </a>
              <a href="{% url 'project_delete' object.pk %}" 
              class="btn btn-danger {% if object.review_status == 'in_review' or object.review_status == 'approved' %}disabled{% endif %}"
              {% if object.review_status == 'in_review' or object.review_status == 'approved' %}tabindex="-1" aria-disabled="true"{% endif %}>
                  Удалить
              </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Управление задачами с проверкой таймера -->
    <script>
        function confirmSubmit() {
            return confirm('Вы действительно хотите отправить проект на проверку? Дальнейшие изменения по нему будут невозможны');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.task-action').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = this.dataset.taskId;
                    fetch("{% url 'change_task_status' 0 %}".replace('0', taskId), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    }).then(r => r.json()).then(data => {
                        if (data.is_success) {
                            window.location.reload();
                        } else {
                            alert(data.error || 'Ошибка');
                        }
                    });
                });
            });
        });
    </script>

{% endblock %}