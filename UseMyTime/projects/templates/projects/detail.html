{% extends "base.html" %}
{% block title %}Проект "{{ object.title }}"{% endblock %}
{% block content %}
    <!-- Название и описание -->
    <h1>{{ object.title }}</h1>
    <p class="mb-4">{{ object.description }}</p>
    <hr>

    <!-- Список задач -->
    {% if object.tasks.all %}
    <h2 class="fw-light">Список задач</h2>
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>Задача</th>
            <th>Статус</th>
            <th>Создана</th>
            <th>Завершена</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for task in object.tasks.all %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td class="{% if task.status == 'done' %}text-muted text-decoration-line-through{% endif %}">{{ task.text }}</td>
            <td>{{ task.get_status_display }}</td>
            <td>{{ task.created_at|date:"d.m.Y H:i" }}</td>
            <td>{% if task.completed_at %}{{ task.completed_at|date:"d.m.Y H:i" }}{% else %}—{% endif %}</td>
            <td class="text-end">
              {% if user.id == object.user.id %}
                {% if task.status == 'new' %}
                <button class="btn btn-sm btn-primary task-action" data-task-id="{{ task.id }}" data-next="start">Начать</button>
                {% elif task.status == 'in_progress' %}
                <button class="btn btn-sm btn-success task-action" data-task-id="{{ task.id }}" data-next="finish">Завершить</button>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center">Задач нет</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <hr>
    {% endif %}

    <!-- Данные о времени работы -->
    <div class="row">
        <div class="col text-start w-75"><h2 class="fw-light">Общее время работы над проектом</h2></div>
        <div class="col text-end"><h1 id="project-total">{{ object.get_hours_minutes_seconds.0 }} часов {{ object.get_hours_minutes_seconds.1 }} мин {{ object.get_hours_minutes_seconds.2 }} сек</h1></div>
    </div>
    <hr>
    <!-- Кнопки управления проектом -->
    <div class="d-flex justify-content-between mt-4">
        <div>
            {% if user.id == object.user.id %}
              {% if not object.is_archived %}
                  {% if not user.active_project or user.active_project.project != object %}
                  <form action="{% url 'projects_activate' %}" method="post" class="d-inline me-2">
                      {% csrf_token %}
                      <input type="hidden" name="project_id" value="{{ object.pk }}">
                      <button type="submit" class="btn text-white" 
                              style="background-color: rgb(6, 46, 101); border-radius:0px;">
                          Активировать проект
                      </button>
                  </form>
                  {% endif %}
                  
                  <form action="{% url 'projects_archivate' object.id %}" method="post" class="d-inline me-2">
                      {% csrf_token %}
                      <button type="submit" class="btn text_white" 
                              style="background-color: rgb(6, 46, 101); border-radius:0px;">
                          В архив
                      </button>
                  </form>
              {% endif %}
            {% endif %}
        </div>
        
        <div>
            {% if user.id == object.user.id %}
              <a href="{% url 'project_update' object.pk %}" 
              class="btn text-white me-2"
              style="background-color: rgb(6, 46, 101); border-radius:0px;">
                  Редактировать
              </a>
              <a href="{% url 'project_delete' object.pk %}" 
              class="btn btn-danger"
              style="border-radius:0px;">
                  Удалить
              </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Управление задачами с проверкой таймера -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.task-action').forEach(btn => {
                btn.addEventListener('click', function() {
                    const taskId = this.dataset.taskId;
                    fetch("{% url 'change_task_status' 0 %}".replace('0', taskId), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    }).then(r => r.json()).then(data => {
                        if (data.is_success) {
                            window.location.reload();
                        } else {
                            alert(data.error || 'Ошибка');
                        }
                    });
                });
            });
        });
    </script>

    <!-- Блок проверки проекта -->
    <div class="mt-4">
      <h2 class="fw-light">Проверка проекта</h2>
      <div class="d-flex justify-content-between align-items-center">
        <div>
          Текущий статус: 
          {% if object.review_status == 'none' %}Не на проверке{% endif %}
          {% if object.review_status == 'in_review' %}На проверке{% endif %}
          {% if object.review_status == 'approved' %}Принят{% endif %}
          {% if object.review_status == 'rejected' %}Возвращен{% if object.review_comment %}: {{ object.review_comment }}{% endif %}{% endif %}
        </div>
        <div>
          {% if can_submit_review and user.id == object.user.id %}
          <form method="post" action="{% url 'project_submit_review' object.pk %}" class="d-inline" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="text" name="submit_comment" class="form-control d-inline-block me-2" style="width:260px" placeholder="Комментарий (опционально)"/>
            <input type="file" name="files" class="form-control d-inline-block me-2" style="width:260px" multiple />
            <button class="btn btn-warning">Отправить на проверку</button>
          </form>
          {% endif %}

          {% with role=user.profile.role|default:'' %}
          {% if role == 'manager' or role == 'sector_manager' %}
            {% if object.review_status == 'in_review' %}
            <form method="post" action="{% url 'project_review_approve' object.pk %}" class="d-inline ms-2">
              {% csrf_token %}
              <button class="btn btn-success">Принять</button>
            </form>
            <form method="post" action="{% url 'project_review_reject' object.pk %}" class="d-inline ms-2">
              {% csrf_token %}
              <input type="text" name="review_comment" class="form-control d-inline-block me-2" style="width:260px" placeholder="Комментарий"/>
              <button class="btn btn-danger">Вернуть</button>
            </form>
            {% endif %}
          {% endif %}
          {% endwith %}
        </div>
      </div>
      {% if object.submit_comment or object.attachments.all %}
      <div class="mt-3">
        <div class="small text-muted">Материалы отправки</div>
        {% if object.submit_comment %}
          <div class="mb-1">Комментарий: {{ object.submit_comment }}</div>
        {% endif %}
        {% if object.attachments.all %}
          <ul class="mb-0">
            {% for a in object.attachments.all %}
              <li><a href="{% url 'project_attachment_download' object.pk a.pk %}" target="_blank">Файл {{ forloop.counter }}</a> <span class="text-muted small">от {{ a.uploaded_at|date:"d.m.Y H:i" }}</span></li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      {% endif %}
    </div>
{% endblock %}