{% extends 'base.html' %}

{% block title %}Мой отдел{% endblock %}

{% block content %}
<!-- Вывод сообщений -->
{% if messages %}
    <div class="messages">
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<h1>Мой отдел</h1>

<div id="team-list">
    {% for item in team_tasks %}
    <div class="employee-item mb-2">
        <!-- Кликабельный заголовок с Bootstrap collapse -->
        <div class="d-flex align-items-center text-decoration-none p-3"
             data-bs-toggle="collapse"
             href="#tasksCollapse-{{ item.employee.id }}"
             role="button"
             aria-expanded="false"
             aria-controls="tasksCollapse-{{ item.employee.id }}"
             style="cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
            <strong>{{ item.employee.user.last_name }} {{ item.employee.user.first_name }} </strong>&nbsp;— {{ item.employee.position }}
            <!-- SVG-иконка: caret-right по умолчанию -->
            <span class="ms-auto toggle-icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                    <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
                </svg>
            </span>
        </div>

        <!-- Блок с задачами: плавное раскрытие через Bootstrap -->
        <div class="collapse" id="tasksCollapse-{{ item.employee.id }}" style="border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;">
            <div class="p-3" style="background: #fff;">
                <h4>Задачи в проектах</h4>
                {% if item.tasks %}
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Проект</th>
                                <th>Задача</th>
                                <th>Статус</th>
                                <th>Создана</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in item.tasks %}
                                <tr>
                                    <td>{{ task.project.title }}</td>
                                    <td>{{ task.text|truncatechars:80 }}</td>
                                    <td>
                                        {% if task.is_done %}
                                            <span class="badge bg-success">Выполнено</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Не выполнено</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ task.created_at|date:"d.m.Y" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p><em>Нет задач в проектах.</em></p>
                {% endif %}

                <!-- Кнопки управления -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-success" 
                            data-bs-toggle="modal" 
                            data-bs-target="#employeeReportModal{{ item.employee.id }}">
                        Сформировать отчёт
                    </button>
                    <a href="{% url 'edit_employee' user_id=item.employee.user.id %}" class="btn btn-sm btn-outline-primary">Редактировать</a>
                </div>
                
                <!-- Модальное окно для отчета по сотруднику -->
                <div class="modal fade" id="employeeReportModal{{ item.employee.id }}" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Отчет по сотруднику: {{ item.employee.user.last_name }} {{ item.employee.user.first_name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="employeeReportForm{{ item.employee.id }}">
                                    <div class="mb-3">
                                        <label for="emp_start_date{{ item.employee.id }}" class="form-label">Дата начала периода</label>
                                        <input type="date" class="form-control" id="emp_start_date{{ item.employee.id }}" 
                                               name="start_date" value="{{ default_start_date }}">
                                        <small class="form-text text-muted">Оставьте пустым для отчета за все время</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="emp_end_date{{ item.employee.id }}" class="form-label">Дата окончания периода</label>
                                        <input type="date" class="form-control" id="emp_end_date{{ item.employee.id }}" 
                                               name="end_date" value="{{ default_end_date }}">
                                        <small class="form-text text-muted">Оставьте пустым для отчета за все время</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Формат отчета</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="format{{ item.employee.id }}" 
                                                   id="empFormatHTML{{ item.employee.id }}" value="html" checked>
                                            <label class="form-check-label" for="empFormatHTML{{ item.employee.id }}">
                                                Просмотр в браузере (HTML)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" 
                                                   name="format{{ item.employee.id }}" 
                                                   id="empFormatPDF{{ item.employee.id }}" value="pdf">
                                            <label class="form-check-label" for="empFormatPDF{{ item.employee.id }}">
                                                Скачать PDF
                                            </label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                <button type="button" class="btn btn-success" 
                                        onclick="generateEmployeeReport({{ item.employee.id }})">
                                    Сформировать отчет
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% empty %}
    <p>В вашей команде пока нет сотрудников.</p>
{% endfor %}
</div>

<!-- Блок добавления сотрудников убран: управление составом команды выполняет администратор через админ-панель. -->

<!-- Кнопки для формирования отчета по всем сотрудникам в отделе -->
<hr>
<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#reportPeriodModal">
    Сформировать отчёт по отделу
</button>

<!-- Модальное окно для выбора периода отчета -->
<div class="modal fade" id="reportPeriodModal" tabindex="-1" aria-labelledby="reportPeriodModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportPeriodModalLabel">Выбор периода отчета</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reportPeriodForm">
                    <div class="mb-3">
                        <label for="start_date" class="form-label">Дата начала периода</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ default_start_date }}">
                        <small class="form-text text-muted">Оставьте пустым для отчета за все время</small>
                    </div>
                    <div class="mb-3">
                        <label for="end_date" class="form-label">Дата окончания периода</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ default_end_date }}">
                        <small class="form-text text-muted">Оставьте пустым для отчета за все время</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Формат отчета</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" id="formatHTML" value="html" checked>
                            <label class="form-check-label" for="formatHTML">
                                Просмотр в браузере (HTML)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="format" id="formatPDF" value="pdf">
                            <label class="form-check-label" for="formatPDF">
                                Скачать PDF
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="generateReport()">Сформировать отчет</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript для открытия/закрытия -->
<script>
// Функция для генерации отчета с выбранными параметрами
function generateReport() {
    const form = document.getElementById('reportPeriodForm');
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    const format = document.querySelector('input[name="format"]:checked').value;
    
    // Формируем URL с параметрами
    let url = '{% url "generate_report" %}?';
    const params = [];
    
    if (startDate) {
        params.push('start_date=' + startDate);
    }
    if (endDate) {
        params.push('end_date=' + endDate);
    }
    if (format === 'pdf') {
        params.push('format=pdf');
    }
    
    url += params.join('&');
    
    // Открываем отчет в новой вкладке
    window.open(url, '_blank');
    
    // Закрываем модальное окно
    const modal = bootstrap.Modal.getInstance(document.getElementById('reportPeriodModal'));
    modal.hide();
}

// Функция для генерации отчета по сотруднику
function generateEmployeeReport(employeeId) {
    const startDate = document.getElementById('emp_start_date' + employeeId).value;
    const endDate = document.getElementById('emp_end_date' + employeeId).value;
    const format = document.querySelector('input[name="format' + employeeId + '"]:checked').value;
    
    // Формируем URL с параметрами
    let url = '/accounts/report/' + employeeId + '/?';
    const params = [];
    
    if (startDate) {
        params.push('start_date=' + startDate);
    }
    if (endDate) {
        params.push('end_date=' + endDate);
    }
    if (format === 'pdf') {
        params.push('format=pdf');
    }
    
    url += params.join('&');
    
    // Открываем отчет в новой вкладке
    window.open(url, '_blank');
    
    // Закрываем модальное окно
    const modal = bootstrap.Modal.getInstance(document.getElementById('employeeReportModal' + employeeId));
    modal.hide();
}

document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (trigger) {
        const iconWrapper = trigger.querySelector('.toggle-icon-wrapper');
        const target = document.querySelector(trigger.getAttribute('href'));

        if (!iconWrapper || !target) return;

        // Функции для установки иконок
        function setCaretDown() {
            iconWrapper.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down-fill" viewBox="0 0 16 16">
                    <path d="M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                </svg>`;
        }

        function setCaretRight() {
            iconWrapper.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                    <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
                </svg>`;
        }

        // При открытии
        target.addEventListener('shown.bs.collapse', function () {
            setCaretDown();
        });

        // При закрытии
        target.addEventListener('hidden.bs.collapse', function () {
            setCaretRight();
        });
    });
});
</script>

<style>
    .employee-header {
        transition: background 0.2s ease;
    }
    .employee-header:hover {
        background: #e9ecef;
    }
    .badge {
        font-size: 0.8em;
        padding: 0.5em 0.7em;
    }
</style>

{% endblock %}